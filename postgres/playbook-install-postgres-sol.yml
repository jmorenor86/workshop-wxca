---
- name: Install postgres on ubuntu
  hosts: ngnix-hosts
  become: true

  tasks:
    - name: Update apt package cache
      ansible.builtin.apt:
        update_cache: true
      become: true
    
    - name: Install postgreSQL
      ansible.builtin.package:
        name: postgresql
        state: present
    
    - name: Allow remote access to PostgreSQL with lineinfile
      ansible.builtin.lineinfile:
        path: /etc/postgresql/14/main/postgresql.conf
        regexp: ^
        line: listen_addresses = '*'
        state: present
        backup: true
      notify: Restart postgresql

    - name: Allow PostgreSQL to listen on a specific port with lineinfile
      ansible.builtin.lineinfile:
        path: /etc/postgresql/14/main/postgresql.conf
        regexp: ^
        line: port = 5432
        state: present
      notify: Restart postgresql

    - name: Create postgreSQL user, password and database
      community.postgresql.postgresql_user:
        db: your_database_name
        name: your_username
        password: your_password
        priv: "*.*:ALL"    

  handlers:
    - name: Restart postgresql
      service:
        name: postgresql
        state: restarted
